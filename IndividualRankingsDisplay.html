<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç¬¬äºŒå±Šâ€œé«˜æ ¡æ¯â€ä¸ªäººæˆç»©å±•ç¤º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --duration-sec: 160s;
      --first-screen-ms: 900ms;
      --per-row-sec: 0.8s;
      --font-header: clamp(20px, 3.6vw, 32px);
      --font-base: clamp(14px, 2.6vw, 18px);
      --row-pad: 8px;
      --banner-h: 120px;
      --viewport-h: 600px;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:#000; color:#fff; font-family:Arial, sans-serif; }
    #banner{ display:block; margin:12px auto 6px; height:var(--banner-h); object-fit:contain; }
    h1{ text-align:center; color:#00ffcc; font-size:var(--font-header); margin:6px 0 10px; text-shadow:0 4px 18px rgba(0,255,204,.25); }

    .status{ position:fixed; top:10px; right:10px; display:flex; gap:8px; align-items:center; font-size:.9em; z-index:50; }
    .dot{ width:8px; height:8px; border-radius:50%; background:#555; }
    .dot.ok{ background:#22c55e; } .dot.err{ background:#ef4444; }
    .status small{ opacity:.85 }

    .fixed-header{ display:block; }
    .fixed-header table{ width:100%; table-layout:fixed; border-collapse:collapse; font-size:var(--font-base); }
    .fixed-header th{
      padding:var(--row-pad); background:#333; border-bottom:2px solid #00ffcc; text-align:center;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .scroll-viewport{ height:var(--viewport-h); overflow:hidden; position:relative; }
    .scroller{
      position:absolute; left:0; right:0; top:0;
      will-change:transform;
      animation: scrollUp var(--duration-sec) linear infinite;
      animation-play-state: paused;
    }
    @keyframes scrollUp{ from{ transform:translateY(0); } to{ transform:translateY(-50%); } }
    table.live{ width:100%; table-layout:fixed; border-collapse:collapse; font-size:var(--font-base); }
    td{
      padding:var(--row-pad); text-align:center; border-bottom:1px solid #444;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    tr:nth-child(even){ background:#222; } tr:nth-child(odd){ background:#111; }
    .top-1{ background:#ffd700 !important; color:#111; font-weight:bold; }
    .top-2{ background:#c0c0c0 !important; color:#111; font-weight:bold; }
    .top-3{ background:#cd7f32 !important; color:#111; font-weight:bold; }

    .controls{
      position:fixed; left:0; right:0; bottom:10px; z-index:60;
      display:flex; justify-content:center; gap:10px; padding:6px 10px;
    }
    .btn{ padding:8px 16px; font-size:clamp(14px, 2.4vw, 18px); color:#fff; border:none; border-radius:8px; background:#004a4a; cursor:pointer; }
    .btn:hover{ filter:brightness(1.1); }
    #scroll-toggle{ background:#2563eb; }
    #music-toggle{ background:#0a6848; }

    .toolbar{ text-align:center; font-size:.9em; opacity:.85; margin:8px 0 74px; }

    /* â€”â€” æµ·æŠ¥å¼å‰ä¸‰å â€”â€” */
    #posterWrap{ display:none; position:relative; }
    #fxCanvas{
      position:absolute; inset:0; pointer-events:none; z-index:5; opacity:.9;
      mix-blend-mode:screen;
    }
    .poster{
      max-width:min(1300px, 96vw);
      margin:8px auto 18px; padding:22px 18px;
      background:
        radial-gradient(1200px 420px at 50% -80%, rgba(255,215,0,.20), rgba(0,0,0,0)),
        linear-gradient(180deg, rgba(0,255,204,.06), rgba(0,0,0,0) 28%),
        #0a0a0a;
      border:1px solid #1f1f1f; border-radius:16px;
      box-shadow:0 12px 32px rgba(0,0,0,.55), inset 0 0 40px rgba(0,255,204,.05);
      position:relative; z-index:2;
      animation: posterIn .8s ease both;
    }
    @keyframes posterIn{
      from{ opacity:0; transform:translateY(12px) scale(.98); }
      to  { opacity:1; transform:translateY(0)    scale(1); }
    }
    .poster-title{
      text-align:center; font-size:clamp(24px, 4.5vw, 40px);
      color:#84f2e3; margin-bottom:10px; letter-spacing:1px; font-weight:900;
      text-shadow:0 0 18px rgba(0,255,204,.35), 0 0 4px rgba(0,255,204,.6);
      position:relative;
    }
    .poster-title:after{
      content:""; position:absolute; left:50%; bottom:-8px; width:220px; height:2px; transform:translateX(-50%);
      background:linear-gradient(90deg, rgba(0,255,204,0), #00ffcc, rgba(0,255,204,0));
      filter:drop-shadow(0 0 8px #00ffcc);
    }
    .podium{ display:grid; grid-template-columns: 1fr 1.3fr 1fr; gap:16px; align-items:stretch; }
    .card{
      background:#111; border-radius:18px; padding:18px 16px; text-align:center;
      border:2px solid rgba(255,255,255,.06);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 10px 28px rgba(0,0,0,.4);
      position:relative; overflow:hidden;
    }
    .card:before{
      content:""; position:absolute; inset:-120% -40%; transform:rotate(18deg);
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.33) 50%, rgba(255,255,255,0) 100%);
      animation: shine 4.6s linear infinite; mix-blend-mode:overlay;
    }
    @keyframes shine{ from{ transform:translateX(-30%) rotate(18deg);} to{ transform:translateX(30%) rotate(18deg);} }
    .rank-badge{ display:inline-flex; align-items:center; gap:10px; padding:8px 14px; border-radius:999px; font-weight:900; color:#111;
      background:#ccc; font-size:clamp(18px, 3.5vw, 30px); box-shadow:0 6px 16px rgba(0,0,0,.35); }
    .rank-1 .rank-badge{ background:linear-gradient(145deg,#ffd700,#ffef9b); }
    .rank-2 .rank-badge{ background:linear-gradient(145deg,#d9d9d9,#ffffff); }
    .rank-3 .rank-badge{ background:linear-gradient(145deg,#cd7f32,#f0b07a); }
    .school{ margin:12px 0 10px; font-size:clamp(18px, 3.2vw, 28px); font-weight:900; color:#fff;
      text-shadow:0 3px 0 rgba(0,0,0,.45), 0 8px 26px rgba(255,215,0,.25); letter-spacing:.5px; }
    .name-pill{
      background:#151515; border:1px solid #2a2a2a; border-radius:12px; padding:10px 12px; color:#eaeaea;
      white-space:normal; word-break:break-word; font-size:clamp(20px, 3.5vw, 35px);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
      margin:10px auto 6px; max-width: min(92%, 880px);
    }
    .metrics{ display:flex; justify-content:center; gap:18px; margin-top:8px; font-weight:900; }
    .metric{ background:#0f1e1e; border:1px solid #1f3b3b; padding:8px 12px; border-radius:10px; color:#8cf7e0;
      font-size:clamp(16px, 2.4vw, 22px); box-shadow:0 6px 16px rgba(0,0,0,.25); }
    .rank-1{
      transform:translateY(-8px);
      border-color:rgba(255,215,0,.38);
      box-shadow: 0 14px 30px rgba(255,215,0,.15), 0 0 42px rgba(255,215,0,.25), inset 0 0 22px rgba(255,215,0,.18);
      animation: crownPulse 2.4s ease-in-out infinite;
    }
    @keyframes crownPulse{
      0%,100%{ box-shadow:0 12px 28px rgba(255,215,0,.12), 0 0 30px rgba(255,215,0,.18), inset 0 0 18px rgba(255,215,0,.14); }
      50%    { box-shadow:0 18px 36px rgba(255,215,0,.22), 0 0 52px rgba(255,215,0,.32), inset 0 0 26px rgba(255,215,0,.22); }
    }
    @media (max-width:900px){ .podium{ grid-template-columns: 1fr; } .rank-1{ order:-1; } }

    /* â€”â€” ä¼˜èƒœé€‰æ‰‹ï¼ˆç¬¬ 4â€“13 åï¼‰é™æ€å±•ç¤º â€”â€” */
    #winnersWrap{ display:none; }
    .winners{ max-width:min(1300px, 96vw); margin:8px auto 18px; }
    .winners-table{ width:100%; table-layout:fixed; border-collapse:collapse; font-size:var(--font-base); }
    .winners-table th{
      padding:var(--row-pad); background:#333; border-bottom:2px solid #00ffcc; text-align:center;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .winners-table td{
      padding:var(--row-pad); text-align:center; border-bottom:1px solid #444;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .winners-table tr:nth-child(even){ background:#222; }
    .winners-table tr:nth-child(odd){ background:#111; }
  </style>
</head>
<body>
  <div class="status"><div id="netDot" class="dot"></div><small id="statusText">è¿æ¥ä¸­â€¦</small></div>

  <img id="banner" src="banner.png" alt="Banner" />
  <h1 id="pageTitle">ç¬¬äºŒå±Šâ€œé«˜æ ¡æ¯â€ä¸ªäººæˆç»©å±•ç¤º</h1>

  <!-- å›ºå®šè¡¨å¤´ -->
  <div class="fixed-header" id="tableHeader">
    <table>
      <colgroup>
        <col style="width:10%"><col style="width:24%"><col style="width:36%"><col style="width:15%"><col style="width:15%">
      </colgroup>
      <thead><tr>
        <th>åæ¬¡</th><th>æ ¡å‹ä¼š</th><th>é€‰æ‰‹</th><th>å±€åˆ†ç´¯è®¡</th><th>å°åˆ†ç´¯è®¡</th>
      </tr></thead>
    </table>
  </div>

  <!-- æµ·æŠ¥æ¨¡å¼ -->
  <div id="posterWrap">
    <canvas id="fxCanvas"></canvas>
    <div class="poster">
      <div class="poster-title">ğŸ† ä¸ªäººå‰ä¸‰å </div>
      <div id="podium" class="podium"></div>
    </div>
  </div>

  <!-- ä¼˜èƒœé€‰æ‰‹ï¼ˆç¬¬ 4â€“13 åï¼‰ -->
  <div id="winnersWrap">
    <div class="winners">
      <table class="winners-table">
        <colgroup>
          <col style="width:32%"><col style="width:38%"><col style="width:15%"><col style="width:15%">
        </colgroup>
        <thead><tr>
          <th>æ ¡å‹ä¼š</th><th>é€‰æ‰‹å§“å</th><th>å±€åˆ†ç´¯è®¡</th><th>å°åˆ†ç´¯è®¡</th>
        </tr></thead>
        <tbody id="winnersBody"></tbody>
      </table>
    </div>
  </div>

  <!-- æ»šåŠ¨ä¸»ä½“ -->
  <div class="scroll-viewport" id="scrollView">
    <div id="scroller" class="scroller">
      <table class="live">
        <colgroup>
          <col style="width:10%"><col style="width:24%"><col style="width:36%"><col style="width:15%"><col style="width:15%">
        </colgroup>
        <tbody id="tbodyA"></tbody>
      </table>
      <table class="live">
        <colgroup>
          <col style="width:10%"><col style="width:24%"><col style="width:36%"><col style="width:15%"><col style="width:15%">
        </colgroup>
        <tbody id="tbodyB"></tbody>
      </table>
    </div>
  </div>

  <!-- åº•éƒ¨æ§åˆ¶ -->
  <div class="controls">
    <button class="btn" id="btn-poster">å‰ä¸‰å</button>
    <button class="btn" id="btn-winners">ä¼˜èƒœé€‰æ‰‹</button>
    <button class="btn" id="btn-all">æ˜¾ç¤ºå…¨éƒ¨</button>
    <button class="btn" id="scroll-toggle">â¸ æš‚åœ</button>
    <button class="btn" id="music-toggle">ğŸµ éŸ³ä¹</button>
  </div>

  <audio id="bgm" src="bgmusic.mp3" preload="auto" loop></audio>

  <script>
    /* ===== é…ç½®ï¼šæ”¯æŒ ?api= è¦†ç›– ===== */
    const DEFAULT_API = "https://script.google.com/macros/s/AKfycbzvZYwaxJnHxiKCmS-Heo6nE7N1-M3TX11I_rrGSV8OuFWrZ0ilT0nhXby4HnZ-jJI/exec";
    const url = new URL(location.href);
    const API_URL = url.searchParams.get("api") || DEFAULT_API;

    const POLL_MS = 10000, FIRST_SCREEN_MS = 900;

    const scroller = document.getElementById('scroller');
    const viewport = document.getElementById('scrollView');
    const tableHeader = document.getElementById('tableHeader');
    const tbodyA = document.getElementById('tbodyA');
    const tbodyB = document.getElementById('tbodyB');
    const netDot = document.getElementById('netDot');
    const statusText = document.getElementById('statusText');

    const btnPoster = document.getElementById('btn-poster');
    const btnWinners = document.getElementById('btn-winners');
    const btnAll = document.getElementById('btn-all');
    const scrollToggle = document.getElementById('scroll-toggle');

    const posterWrap = document.getElementById('posterWrap');
    const podium = document.getElementById('podium');
    const fxCanvas = document.getElementById('fxCanvas');
    const fxCtx = fxCanvas.getContext('2d');

    const winnersWrap = document.getElementById('winnersWrap');
    const winnersBody = document.getElementById('winnersBody');
    const pageTitle = document.getElementById('pageTitle');
    const DEFAULT_TITLE = pageTitle.textContent;

    let allRows = [];
    let mode = 'all';          // 'all' | 'poster' | 'winners'
    let displayPaused = false;
    let pollTimer = null, autoStartTimer = null;
    let particles = [], fxLoop=null;

    const trim = v => (v==null ? "" : String(v).trim());
    function setNet(ok,msg){ netDot.className='dot '+(ok?'ok':'err'); statusText.textContent = msg || (ok?'åœ¨çº¿':'é‡è¯•ä¸­â€¦'); }

    async function fetchJSON(u, tries=3, baseDelay=1200){
      for(let i=0;i<tries;i++){
        try{
          const r = await fetch(u, {cache:'no-store'});
          if(!r.ok) throw new Error(String(r.status));
          setNet(true,'åœ¨çº¿');
          return await r.json();
        }catch(e){
          setNet(false, `é‡è¯• ${i+1}/${tries}`);
          if(i===tries-1) throw e;
          await new Promise(res=>setTimeout(res, baseDelay*(i+1)));
        }
      }
    }

    /* -------- æ›´ç¨³å¥çš„è¡¨å¤´æ£€æµ‹ï¼šé¿å…è¯¯æŠŠç¬¬1åå½“è¡¨å¤´ -------- */
    function looksLikeHeader_(cells, nextRow){
      const arr = (cells || []).map(c=>trim(c));
      if (!arr.length) return false;

      // å‘½ä¸­å…¸å‹æ ‡é¢˜çš„æ•°é‡
      const keys = ['åæ¬¡','æ ¡å‹ä¼š','é€‰æ‰‹','å§“å','å±€åˆ†','å°åˆ†','rank','school','name','set','point'];
      let hits = 0;
      for (const v of arr){
        const low = v.toLowerCase();
        if (keys.some(k => low.includes(k))) hits++;
      }

      // é¦–åˆ—æ˜¯å¦æ•°å­—ï¼ˆä¾‹å¦‚åæ¬¡ï¼‰
      const firstNum = Number.isFinite(Number(arr[0].replace(/[^\d.-]/g,'')));
      const nextFirstNum = nextRow
        ? Number.isFinite(Number(trim(nextRow[0]).replace(/[^\d.-]/g,'')))
        : false;

      // åˆ¤å®šè§„åˆ™ï¼šè‡³å°‘2å‘½ä¸­æ ‡é¢˜ï¼Œæˆ–ï¼ˆé¦–è¡Œéæ•°å­—ä½†æ¬¡è¡Œæ˜¯æ•°å­—ï¼‰
      if (hits >= 2) return true;
      if (!firstNum && nextFirstNum) return true;
      return false;
    }

    function parsePayload(payload){
      let rows = [];
      if (payload && Array.isArray(payload.rows)) rows = payload.rows;
      else if (payload && Array.isArray(payload.data)) rows = payload.data;
      else if (Array.isArray(payload)) rows = payload;
      else if (payload && Array.isArray(payload.table)) rows = payload.table;
      else rows = [];
      rows = rows.map(r => (Array.isArray(r) ? r.map(trim) : []));
      while (rows.length && rows[0].every(c => c === '')) rows.shift();
      if (!rows.length) return { header:[], data:[] };

      const noHeaderParam = url.searchParams.get('noHeader'); // æ”¯æŒ ?noHeader=1 å¼ºåˆ¶æ— è¡¨å¤´
      if (noHeaderParam === '1') return { header:[], data:rows };

      const hasHeader = looksLikeHeader_(rows[0], rows[1]);
      return hasHeader ? { header: rows[0], data: rows.slice(1) } : { header: [], data: rows };
    }

    /* åˆ—å®šä½ï¼ˆå¤§å°å†™/å…³é”®è¯å®¹é”™ï¼‰ï¼›è‹¥æ— è¡¨å¤´ï¼Œç”¨åå¤‡ç´¢å¼• + æ™ºèƒ½çŒœå­¦æ ¡åˆ— */
    function buildColumnIndex(header, rows){
      const lc = (header || []).map(h => (h||'').toLowerCase());
      const find = (keys) => lc.findIndex(h => keys.some(k => h.includes(k)));
      let idx = {
        rank:   find(['åæ¬¡','rank']),
        school: find(['æ ¡å‹ä¼š','å­¦æ ¡','é™¢æ ¡','school','univ','university','college','team','club']),
        name:   find(['é€‰æ‰‹','å§“å','name','players']),
        setSum: find(['å±€åˆ†ç´¯','å±€åˆ†','set']),
        smSum:  find(['å°åˆ†ç´¯','å°åˆ†','point'])
      };
      if (idx.rank  < 0) idx.rank  = 0;
      if (idx.name  < 0) idx.name  = 2;
      if (idx.setSum< 0) idx.setSum= 3;
      if (idx.smSum < 0) idx.smSum = 4;

      if (idx.school < 0){
        idx.school = (function guessSchoolIdx(rows){
          const sample = (rows || []).slice(0, 15);
          const cols = Math.max(0, ...sample.map(r => r.length));
          let best = -1, bestScore = -1;
          for (let c = 0; c < cols; c++){
            let score = 0;
            for (const r of sample){
              const v = (r[c] || '').trim();
              if (!v) continue;
              if (/^[A-Z]\d{1,2}$/i.test(v)) { score -= 4; continue; }
              if (/[å­¦é™¢æ ¡å¤§]|university|college/i.test(v)) score += 4;
              if (/[^\x00-\x7F]/.test(v)) score += 1;
              if (v.length >= 4)          score += 2;
            }
            if (score > bestScore){ bestScore = score; best = c; }
          }
          return best >= 0 ? best : 1;
        })(rows);
      }
      const forceSchool = Number(new URL(location.href).searchParams.get('schoolIdx'));
      if (!Number.isNaN(forceSchool)) idx.school = forceSchool;
      return idx;
    }

    /* åæ¬¡æ•°å€¼åŒ–ï¼ˆå…¼å®¹ â€œç¬¬1å/No.1/1â€ï¼‰ */
    function toRankNumber_(v){
      if (v==null) return NaN;
      const n = Number(String(v).replace(/[^\d.-]/g,''));
      return Number.isFinite(n) ? n : NaN;
    }

    
/* æŠŠåŸå§‹äºŒç»´æ•°ç»„æ˜ å°„ä¸ºç»Ÿä¸€å¯¹è±¡ï¼Œå¹¶åœ¨â€œåæ¬¡åˆ—ç¼ºå¤±/å…¨ä¸º0/æ— æ•ˆâ€æ—¶è‡ªåŠ¨æŒ‰åˆ†æ•°é‡ç®—åæ¬¡ */
function mapRows(data, col){
  const rows = data.map(r => ({
    rawRank:  Number((r[col.rank] ?? '').toString().trim()),   // å¯èƒ½æ˜¯ NaN / 0
    school:   r[col.school],
    name:     r[col.name],
    setSum:   Number((r[col.setSum] ?? 0)),
    smSum:    Number((r[col.smSum]  ?? 0))
  }));

  // åˆ¤å®šè¿™ä¸ªâ€œåæ¬¡åˆ—â€æ˜¯å¦å¯ä¿¡ï¼šå¿…é¡»å¤§äº0ã€ä¸”ä¸æ˜¯â€œå…¨éƒ¨ç›¸åŒâ€
  const ranks = rows.map(o => o.rawRank).filter(n => Number.isFinite(n));
  const uniq  = new Set(ranks);
  const hasPositive = ranks.some(n => n > 0);
  const looksSorted  = ranks.length >= 3 && (ranks[0] <= ranks[1] || ranks[0] === 1); // å®½æ¾åˆ¤æ–­

  const rankColumnLooksValid =
    hasPositive && uniq.size > 1; // åªè¦ä¸æ˜¯å…¨ 0/å…¨ç›¸ç­‰ï¼Œå°±ç®—â€œæœ‰ç”¨â€

  let out;
  if (rankColumnLooksValid){
    // ä½¿ç”¨æä¾›çš„åæ¬¡ï¼Œå¹¶æŒ‰åæ¬¡å‡åºæ’åº
    out = rows.map(o => ({
      rank: o.rawRank,
      school:o.school, name:o.name, setSum:o.setSum, smSum:o.smSum
    })).sort((a,b)=>a.rank-b.rank);
  } else {
    // åæ¬¡åˆ—ä¸å¯ç”¨ï¼šæŒ‰â€œå±€åˆ†â†“ã€å°åˆ†â†“ã€å§“åå­—å…¸åºâ€é‡æ’å¹¶è¡¥åæ¬¡
    out = rows.slice().sort((a,b)=>{
      if (b.setSum !== a.setSum) return b.setSum - a.setSum;
      if (b.smSum  !== a.smSum ) return b.smSum  - a.smSum;
      return String(a.name||'').localeCompare(String(b.name||''),'zh');
    }).map((o,i)=>({
      rank: i+1,
      school:o.school, name:o.name, setSum:o.setSum, smSum:o.smSum
    }));
  }
  return out;
}



    function trFor(row){
      const tr = document.createElement('tr');
      if (row.rank===1) tr.classList.add('top-1');
      else if (row.rank===2) tr.classList.add('top-2');
      else if (row.rank===3) tr.classList.add('top-3');
      [row.rank,row.school,row.name,row.setSum,row.smSum].forEach((v)=>{
        const td=document.createElement('td'); td.textContent=(v==null||v==='')?'â€”':String(v); tr.appendChild(td);
      });
      return tr;
    }
    function fillAndMirror(){
      tbodyB.innerHTML=''; Array.from(tbodyA.children).forEach(tr=>tbodyB.appendChild(tr.cloneNode(true)));
      let guard=0;
      while(tbodyA.offsetHeight<viewport.clientHeight && guard<6){
        const clones=Array.from(tbodyA.children).map(tr=>tr.cloneNode(true));
        clones.forEach(n=>tbodyA.appendChild(n)); guard++;
        tbodyB.innerHTML=''; Array.from(tbodyA.children).forEach(tr=>tbodyB.appendChild(tr.cloneNode(true)));
      }
    }
    function renderTable(){
      const rows = allRows;
      tbodyA.innerHTML=''; rows.forEach(r=>tbodyA.appendChild(trFor(r)));
      fillAndMirror();
      const doubled = Math.max(1, rows.length*2);
      const per = 0.8;
      const duration = Math.max(30, Math.round(doubled*per));
      scroller.style.setProperty('--duration-sec', duration+'s');
      scroller.style.transform='translateY(0)';
      scroller.style.animationPlayState='paused';
      if (autoStartTimer) clearTimeout(autoStartTimer);
      autoStartTimer=setTimeout(()=>{ if(!displayPaused && mode==='all') scroller.style.animationPlayState='running'; }, FIRST_SCREEN_MS);
    }

    /* æµ·æŠ¥æ¸²æŸ“ï¼ˆå‰ä¸‰åï¼‰ */
    function posterCard(o, rank){
      const wrap=document.createElement('div');
      wrap.className='card rank-'+rank;
      const emoji = rank===1?'ğŸ†':(rank===2?'ğŸ¥ˆ':'ğŸ¥‰');
      const crown = rank===1?' ğŸ‘‘':'';
      wrap.innerHTML = `
        <div class="rank-badge">${emoji} ç¬¬ ${o.rank} å</div>
        <div class="school">${o.school||'â€”'}${crown}</div>
        <div class="name-pill">${o.name||'â€”'}</div>
        <div class="metrics">
          <div class="metric">å±€åˆ†ï¼š${o.setSum||'â€”'}</div>
          <div class="metric">å°åˆ†ï¼š${o.smSum||'â€”'}</div>
        </div>
      `;
      return wrap;
    }
    function renderPoster(){
      const t3 = allRows.slice(0,3);
      podium.innerHTML='';
      if (t3.length<3){ podium.innerHTML='<div style="text-align:center;opacity:.8">æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆå‰ä¸‰å</div>'; return; }
      podium.appendChild(posterCard(t3[1],2));
      podium.appendChild(posterCard(t3[0],1));
      podium.appendChild(posterCard(t3[2],3));
      resizeFxCanvas(); startParticles();
    }

    function renderWinners(){
      const winners = allRows.filter(o => o.rank >= 4 && o.rank <= 13).slice(0, 10);
      winnersBody.innerHTML = '';
      winners.forEach(o=>{
        const tr=document.createElement('tr');
        [o.school, o.name, o.setSum, o.smSum].forEach(v=>{
          const td=document.createElement('td'); td.textContent = (v==null||v==='')?'â€”':String(v); tr.appendChild(td);
        });
        winnersBody.appendChild(tr);
      });
    }

    async function loadData(){
      const payload = await fetchJSON(API_URL);
      const parsed = parsePayload(payload);
      const col = buildColumnIndex(parsed.header, parsed.data);
      allRows = mapRows(parsed.data, col);
      if (mode==='poster'){ renderPoster(); }
      else if (mode==='winners'){ renderWinners(); }
      else { renderTable(); }
    }

    function startPolling(){
      if (pollTimer) clearInterval(pollTimer);
      pollTimer=setInterval(async()=>{ try{ await loadData(); setNet(true,'åœ¨çº¿'); }catch(e){ setNet(false,'é‡è¯•ä¸­â€¦'); } }, POLL_MS);
    }
    function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }

    function applyMode(){
      if (mode==='poster'){
        pageTitle.textContent = DEFAULT_TITLE;
        winnersWrap.style.display='none';
        posterWrap.style.display='block';
        tableHeader.style.display='none';
        viewport.style.display='none';
        scroller.style.animationPlayState='paused';
        renderPoster();
      }else if (mode==='winners'){
        pageTitle.textContent = 'ç¬¬äºŒå±Šâ€œé«˜æ ¡æ¯â€æ¼è›‹å¤§èµ›ä¼˜èƒœé€‰æ‰‹';
        stopParticles();
        posterWrap.style.display='none';
        tableHeader.style.display='none';
        viewport.style.display='none';
        winnersWrap.style.display='block';
        scroller.style.animationPlayState='paused';
        renderWinners();
      }else{
        pageTitle.textContent = DEFAULT_TITLE;
        stopParticles();
        winnersWrap.style.display='none';
        posterWrap.style.display='none';
        tableHeader.style.display='block';
        viewport.style.display='block';
        if (!displayPaused) scroller.style.animationPlayState='running';
        renderTable();
      }
    }

    btnPoster.addEventListener('click', ()=>{ mode='poster'; applyMode(); });
    btnWinners.addEventListener('click', ()=>{ mode='winners'; applyMode(); });
    btnAll.addEventListener('click', ()=>{ mode='all'; applyMode(); });

    function setDisplayPaused(p){
      displayPaused=p;
      if (mode==='all'){
        scroller.style.animationPlayState = p?'paused':'running';
      }else{
        scroller.style.animationPlayState='paused';
      }
      if (p) stopPolling(); else { startPolling(); loadData().catch(()=>{}); }
      scrollToggle.textContent = p ? 'â–¶ï¸ æ˜¾ç¤º' : 'â¸ æš‚åœ';
    }
    scrollToggle.addEventListener('click', ()=> setDisplayPaused(!displayPaused));
    window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); setDisplayPaused(!displayPaused); } });

    (function initMusic(){
      const audio=document.getElementById('bgm'); const btn=document.getElementById('music-toggle');
      const tryPlay=()=>audio.play().catch(()=>{});
      document.body.addEventListener('click', tryPlay, {once:true});
      document.body.addEventListener('touchstart', tryPlay, {once:true});
      btn.addEventListener('click', ()=>{ if(audio.paused){ audio.play(); btn.textContent='â¸ éŸ³ä¹'; } else { audio.pause(); btn.textContent='ğŸµ éŸ³ä¹'; } });
    })();

    function resizeFxCanvas(){
      const r = document.getElementById('posterWrap').getBoundingClientRect();
      fxCanvas.width = Math.floor(r.width);
      fxCanvas.height = Math.floor(r.height);
    }
    window.addEventListener('resize', ()=>{ if(mode==='poster') resizeFxCanvas(); });

    function startParticles(){
      particles = [];
      for(let i=0;i<70;i++){
        particles.push({
          x: Math.random()*fxCanvas.width,
          y: Math.random()*fxCanvas.height,
          vx: (Math.random()-.5)*0.3,
          vy: - (0.4+Math.random()*0.6),
          r: 1 + Math.random()*2.2,
          a: .6 + Math.random()*.4,
          hue: 40 + Math.random()*60
        });
      }
      if (!fxLoop) fxLoop = requestAnimationFrame(tick);
    }
    function stopParticles(){
      if (fxLoop){ cancelAnimationFrame(fxLoop); fxLoop=null; }
      particles.length=0;
      fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    }
    function tick(){
      fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
      const g = fxCtx.createRadialGradient(fxCanvas.width/2, fxCanvas.height*0.1, 20, fxCanvas.width/2, fxCanvas.height*0.1, fxCanvas.width);
      g.addColorStop(0, 'rgba(255,230,120,0.10)'); g.addColorStop(1, 'rgba(0,0,0,0)');
      fxCtx.fillStyle = g; fxCtx.fillRect(0,0,fxCanvas.width,fxCanvas.height);

      particles.forEach(p=>{
        p.x += p.vx; p.y += p.vy; p.a -= 0.0025;
        if (p.y < -10 || p.a<=0){
          p.x = Math.random()*fxCanvas.width;
          p.y = fxCanvas.height + Math.random()*20;
          p.vx = (Math.random()-.5)*0.3; p.vy = - (0.4+Math.random()*0.6);
          p.r  = 1 + Math.random()*2.2; p.a  = .6 + Math.random()*.4;
          p.hue= 40 + Math.random()*60;
        }
        fxCtx.beginPath(); fxCtx.fillStyle = `hsla(${p.hue}, 90%, 65%, ${p.a})`;
        fxCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); fxCtx.fill();
      });
      fxLoop = requestAnimationFrame(tick);
    }

    (async ()=>{
      try{ await loadData(); setNet(true,'åœ¨çº¿'); } catch(e){ setNet(false,'åˆæ¬¡åŠ è½½å¤±è´¥'); }
      startPolling();
      mode='all'; applyMode();
      setTimeout(()=>{ if(!displayPaused && mode==='all') scroller.style.animationPlayState='running'; }, FIRST_SCREEN_MS);
    })();
  </script>
</body>
</html>
